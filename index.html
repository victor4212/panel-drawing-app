<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Drawing</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background-color: white;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    /* Fixed drawing area */
    #drawingArea {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 1200px;
      height: 850px;
      border: 1px solid #000;
      background: #fff;
      overflow: hidden;
    }

    #drawingArea canvas { display: block; }

    /* 4 small arrows to help center the drawing (clickable) */
    .centerArrow {
      position: absolute;
      font-size: 18px;
      color: #000;
      opacity: 0.5;
      cursor: pointer;
      pointer-events: auto;
    }
    .arrowTop    { top: 4px;    left: 50%; transform: translateX(-50%); }
    .arrowBottom { bottom: 4px; left: 50%; transform: translateX(-50%) rotate(180deg); }
    .arrowLeft   { left: 4px;   top: 50%;  transform: translateY(-50%) rotate(-90deg); }
    .arrowRight  { right: 4px;  top: 50%;  transform: translateY(-50%) rotate(90deg); }

    /* HTML overlay for line labels */
    #labelsOverlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 15;
    }
    .lineLabel {
      position: absolute;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 14px;
      color: #000;
      white-space: nowrap;
      pointer-events: auto;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
      background: rgba(255,255,255,.9);
      padding: 6px 8px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,.06);
    }
    #zoomSliderContainer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      z-index: 20;
    }
    #zoomSlider { width: 50%; }

    #iconUploader, #textControls, #labelControls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 20;
      background: rgba(255,255,255,.9);
      padding: 6px 8px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,.06);
    }
    #textControls { top: 140px; }
    #labelControls { top: 270px; }

    /* Action bar: 2 buttons per row */
    #actionBar {
      position: fixed;
      right: 10px;
      top: 360px;
      z-index: 21;
      display: grid;
      grid-template-columns: repeat(2, max-content);
      grid-auto-rows: auto;
      gap: 6px 10px;
      align-items: center;
      background: rgba(255,255,255,.9);
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
    }
    #actionBar button { white-space: nowrap; }

    #textControls button,
    #iconUploader button,
    #labelControls button { margin-right: 5px; }

    .icon {
      position: absolute;
      width: 100px; height: 100px;
      z-index: 22;
      border: 0px dashed #000;
      transform-origin: center center;
    }
    .icon img { width: 100%; height: 100%; object-fit: contain; }

    .textContainer {
      position: absolute;
      padding: 5px;
      z-index: 22;
      border: 0px dashed #000;
      transform-origin: center center;
      background: transparent;
    }
    .textElement {
      font-size: 20px;
      white-space: pre-wrap;
      line-height: 1.2;
    }

    /* CHANGED: these are now text inputs to allow fractions */
    #partNumber,
    #width, #length, #thickness,
    #lineLengthY, #distanceFromX,
    #lineLengthX, #distanceFromY,
    #iconSize, #textSize { width: 100px; }

    #lineType { width: 180px; }

    .selected { outline: 3px solid #216cff; border-radius: 6px; }

    .textContainer, .icon {
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      cursor: grab;
    }
    .dragging { cursor: grabbing; }

    /* ===== Saved Parts DB ===== */
    #dbPanel{
      position: fixed;
      right: 10px;
      top: 10px;
      width: 320px;
      z-index: 25;
      background: rgba(255,255,255,.95);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.10);
      padding: 10px;
    }
    #dbPanel h3{ margin:0 0 8px 0; font-size:14px; }
    #dbPanel .row{ display:flex; gap:6px; align-items:center; }
    #dbSearch{
      flex:1;
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #dbTableWrap{
      margin-top:8px;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      overflow: hidden;
    }
    /* Scroll ONLY inside the table */
    #dbTableScroll{
      max-height: 240px;
      overflow: auto;
    }
    #dbTable{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    #dbTable thead th{
      position: sticky;
      top: 0;
      background: #f6f6f6;
      z-index: 1;
      text-align:left;
      padding: 8px;
      border-bottom: 1px solid #e6e6e6;
    }
    #dbTable td{
      padding: 8px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    #dbTable td:nth-child(2),
    #dbTable td:nth-child(3){
      text-align:right;
      width: 70px;
      white-space: nowrap;
    }
    #dbTable button{
      padding: 4px 10px;
      border: 1px solid #bdbdbd;
      background: #fff;
      border-radius: 999px;
      cursor:pointer;
    }
    #dbActions{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- Fixed drawing area (1200 x 850) -->
  <div id="drawingArea">
    <div id="labelsOverlay"></div>
    <div class="centerArrow arrowTop">▲</div>
    <div class="centerArrow arrowBottom">▲</div>
    <div class="centerArrow arrowLeft">▲</div>
    <div class="centerArrow arrowRight">▲</div>
  </div>

  <div id="controls">
    <label>Part Number: <input type="text" id="partNumber" placeholder="e.g. P-12345"></label><br>

    <label>Length: <input type="text" id="width" value="48"></label><br>
    <label>Width: <input type="text" id="length" value="36"></label><br>
    <label>Thickness: <input type="text" id="thickness" value="1"></label><br>

    <label>Panel Preset:
      <select id="panelPreset">
        <option value="custom">Custom (manual)</option>
        <option value="48x48x1">48 × 48 × 1</option>
        <option value="48x96x1">48 × 96 × 1</option>
        <option value="96x48x1">96 × 48 × 1</option>
        <option value="96x96x2">96 × 96 × 2</option>
      </select>
    </label><br>

    <label>Run Direction:
      <select id="runDirection">
        <option value="none">None</option>
        <option value="xPlus">Along length →</option>
        <option value="xMinus">Along length ←</option>
        <option value="yPlus">Along width ↑</option>
        <option value="yMinus">Along width ↓</option>
      </select>
    </label><br>

    <label>Width Lines:
      <select id="layoutPresetWidth">
        <option value="none">— Width layout —</option>
        <option value="bands2">2 bands (width)</option>
        <option value="bands3">3 bands (width)</option>
        <option value="bands4">4 bands (width)</option>
        <option value="bands5">5 bands (width)</option>
        <option value="bands6">6 bands (width)</option>
        <option value="bands7">7 bands (width)</option>
        <option value="bands8">8 bands (width)</option>
        <option value="bands9">9 bands (width)</option>
        <option value="bands10">10 bands (width)</option>
        <option value="bands12">12 bands (width)</option>
        <option value="bands15">15 bands (width)</option>
        <option value="bands24">24 bands (width)</option>
      </select>
    </label><br>

    <label>Length Lines:
      <select id="layoutPresetLength">
        <option value="none">— Length layout —</option>
        <option value="bands2">2 bands (length)</option>
        <option value="bands3">3 bands (length)</option>
        <option value="bands4">4 bands (length)</option>
        <option value="bands5">5 bands (length)</option>
        <option value="bands6">6 bands (length)</option>
        <option value="bands7">7 bands (length)</option>
        <option value="bands8">8 bands (length)</option>
        <option value="bands9">9 bands (length)</option>
        <option value="bands10">10 bands (length)</option>
        <option value="bands12">12 bands (length)</option>
        <option value="bands15">15 bands (length)</option>
        <option value="bands24">24 bands (length)</option>
      </select>
    </label><br><br>

    <label>Cut Style:
      <select id="lineType">
        <optgroup label="— Line Styles —">
          <option value="solid">Slit</option>
          <option value="dot">Dot</option>
          <option value="shortDash">Short Dash</option>
          <option value="longDash">Long Dash</option>
          <option value="shortDashDot">Short Dash + Dot</option>
          <option value="longDashDot">Long Dash + Dot</option>
          <option value="shortDash2Dot">Short Dash + 2 Dots</option>
          <option value="longDash2Dot">Long Dash + 2 Dots</option>
        </optgroup>
        <optgroup label="— Shapes on Line —">
          <option value="circle1">Line with 1 Circle</option>
          <option value="circle2">Line with 2 Circles</option>
          <option value="circle3">Line with 3 Circles</option>
          <option value="circle4">Line with 4 Circles</option>
          <option value="triangle1">Line with 1 Triangle</option>
          <option value="triangle2">Line with 2 Triangles</option>
          <option value="triangle3">Line with 3 Triangles</option>
          <option value="triangle4">Line with 4 Triangles</option>
          <option value="square1">Line with 1 Square</option>
          <option value="square2">Line with 2 Squares</option>
          <option value="square3">Line with 3 Squares</option>
          <option value="square4">Line with 4 Squares</option>
        </optgroup>
        <optgroup label="— Symbol Styles —">
          <option value="waterTrigram">☵ Water Trigram</option>
          <option value="mountainTrigram">☶ Mountain Trigram</option>
          <option value="earthTrigram">☷ Earth Trigram</option>
          <option value="yangMonogram">⚍ Yang Monogram</option>
          <option value="yinMonogram">⚏ Yin Monogram</option>
          <option value="recycleSymbol">♻ Recycling Symbol</option>
          <option value="arrowhead">➤ Arrowhead</option>
          <option value="concaveArrow">➨ Concave Arrow</option>
          <option value="doubleAngle">» Double Angle</option>
          <option value="doubleBar">‖ Double Bar</option>
          <option value="diamondArrow">◇─◆─ Pattern</option>
          <option value="crossCross">◈━◈━ Pattern</option>
          <option value="crossDiamond">◈━◆━ Pattern</option>
          <option value="diamondLine">◇─ Line</option>
          <option value="squareLine">◆─ Line</option>
          <option value="heavyDoubleLine">═══ Heavy Line</option>
          <option value="arrowRightLine">──▶ Right Arrow Line</option>
          <option value="arrowLeftLine">◀── Left Arrow Line</option>
        </optgroup>
      </select>
    </label><br>

    <label>Line Width: <input type="text" id="lineLengthY" value="48"></label><br>
    <label>Distance From Width: <input type="text" id="distanceFromX" value="4"></label><br>
    <button onclick="addYtoYLine()">Add Width Line</button><br>

    <label>Line Length: <input type="text" id="lineLengthX" value="36"></label><br>
    <label>Distance From length: <input type="text" id="distanceFromY" value="4"></label><br>
    <button onclick="addXtoXLine()">Add Length Line</button>
    <br><br><br>
    <textarea id="notes" placeholder="Enter notes here..."></textarea>
  </div>

  <div id="zoomSliderContainer">
    <input type="range" id="zoomSlider" min="0" max="100" value="40">
  </div>

  <div id="iconUploader">
    <input type="file" id="uploadIcon" accept="image/*"><br>
    <button id="rotateIconButton">Rotate Icon</button>
    <button id="deleteIconButton">Delete Icon</button><br>
    <label for="iconSize">Icon Size: </label>
    <input type="number" id="iconSize" value="50" step="10"> px<br>
  </div>

  <div id="textControls">
    <label for="textInput">Text:</label><br>
    <textarea id="textInput" rows="4" cols="26" placeholder="Enter multi-line text..."></textarea><br>
    <label for="textSize">Text Size: </label>
    <input type="number" id="textSize" value="12" step="1"><br>
    <button id="addTextButton">Add Text</button><br>
    <button id="rotateTextButton">Rotate Text</button>
    <button id="deleteTextButton">Delete Text</button>
  </div>

  <!-- Saved Parts panel -->
  <div id="dbPanel">
    <h3>Saved Parts</h3>
    <div class="row">
      <input id="dbSearch" type="text" placeholder="Search part number…">
    </div>

      <div class="row" style="margin-top:8px; gap:6px;">
        <button id="cloudConnectBtn" type="button">Connect Cloud</button>
        <button id="cloudDisconnectBtn" type="button">Disconnect</button>
        <span id="cloudStatus" style="font-size:12px;color:#555;">Cloud: <b id="cloudStatusText">Not connected</b></span>
      </div>

      <div class="row" style="margin-top:8px; gap:6px;">
        <button id="cloudSaveBtn" type="button">Save Current</button>
        <button id="cloudLoadBtn" type="button">Load by Part #</button>
      </div>

    <div id="dbTableWrap">
      <div id="dbTableScroll">
        <table id="dbTable">
          <thead>
            <tr>
              <th>Part Number</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="dbTbody"></tbody>
        </table>
      </div>
    </div>

    <div id="dbActions">
      <button id="dbExportBtn" type="button">Export XLSX</button>
      <button id="dbImportBtn" type="button">Import XLSX</button>
      <input id="dbImportInput" type="file" accept=".xlsx,.xls" style="display:none">
    </div>
  </div>

  <!-- Hidden file input for loading state -->
  <input type="file" id="loadStateInput" accept=".json,.txt" style="display:none">

  <!-- Fixed action bar -->
  <div id="actionBar" role="toolbar" aria-label="Drawing actions">
    <button id="undoButton">Undo</button>
    <button id="redoButton">Redo</button>
    <button id="clearButton">Clear All</button>
    <button id="exportButton">Export as JPEG</button>
    <button id="saveStateButton">Save Drawing</button>
    <button id="loadStateButton">Load Drawing</button>
    <button id="exportSpecJsonButton">Export Spec JSON</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script>
    const DRAW_WIDTH  = 1200;
    const DRAW_HEIGHT = 850;

    let viewOffsetX = 0;
    let viewOffsetY = -6;
    const VIEW_STEP  = 0.5;

    let scene, camera, renderer, wireframeBox, lineGroup, shapeGroup, dimensionGroup, runDirectionGroup;
    const drawingArea      = document.getElementById('drawingArea');
    const labelsOverlayDom = document.getElementById('labelsOverlay');

    const partNumberInput   = document.getElementById('partNumber');
    const widthInput        = document.getElementById('width');
    const lengthInput       = document.getElementById('length');
    const thicknessInput    = document.getElementById('thickness');
    const lineLengthYInput  = document.getElementById('lineLengthY');
    const distanceFromXInput= document.getElementById('distanceFromX');
    const lineLengthXInput  = document.getElementById('lineLengthX');
    const distanceFromYInput= document.getElementById('distanceFromY');
    const zoomSlider        = document.getElementById('zoomSlider');
    const notesInput        = document.getElementById('notes');

    // Saved parts UI handles
    const dbSearchInput = document.getElementById('dbSearch');
    const dbExportBtn   = document.getElementById('dbExportBtn');
    const dbImportBtn   = document.getElementById('dbImportBtn');
    const dbImportInput = document.getElementById('dbImportInput');

    let selectedElement = null;
    let rotationAngle = 0;

    const history   = [];
    const redoStack = [];
    const linesModel = [];
    const htmlLabels = [];

    const LINE_COLOR = 0x000000;
    const LINE_STYLES = {
      solid:         { mode: 'solid' },
      shortDash:     { mode: 'dash',    dash: 1.0,  gap: 0.6 },
      longDash:      { mode: 'dash',    dash: 2.4,  gap: 0.8 },
      dot:           { mode: 'dot',     dotRadius: 0.15, dotSpacing: 0.8 },
      shortDashDot:  { mode: 'dashdot', dash: 1.0,  gap: 0.8, dotRadius: 0.15 },
      longDashDot:   { mode: 'dashdot', dash: 3,    gap: 1,   dotRadius: 0.15 },
      shortDash2Dot: { mode: 'dash2dot',dash: 1.0,  gap: 1.7, dotRadius: 0.15 },
      longDash2Dot:  { mode: 'dash2dot',dash: 3,    gap: 2,   dotRadius: 0.15 },
    };

    const STYLE_LABELS = {
      solid:        'Slit',
      dot:          'Dot',
      shortDash:    'Short Dash',
      longDash:     'Long Dash',
      shortDashDot: 'Short Dash + Dot',
      longDashDot:  'Long Dash + Dot',
      shortDash2Dot:'Short Dash + 2 Dots',
      longDash2Dot: 'Long Dash + 2 Dots',

      circle1:   'Circle 1',
      circle2:   'Circle 2',
      circle3:   'Circle 3',
      circle4:   'Circle 4',
      triangle1: 'Triangle 1',
      triangle2: 'Triangle 2',
      triangle3: 'Triangle 3',
      triangle4: 'Triangle 4',
      square1:   'Square 1',
      square2:   'Square 2',
      square3:   'Square 3',
      square4:   'Square 4',

      waterTrigram:    '☵ Water Trigram',
      mountainTrigram: '☶ Mountain Trigram',
      earthTrigram:    '☷ Earth Trigram',
      yangMonogram:    '⚍ Yang Monogram',
      yinMonogram:     '⚏ Yin Monogram',
      recycleSymbol:   '♻ Recycling Symbol',
      arrowhead:       '➤ Arrowhead',
      concaveArrow:    '➨ Concave Arrow',
      doubleAngle:     '» Double Angle',
      doubleBar:       '‖ Double Bar',
      diamondArrow:     '◇─◆─ Pattern',
      crossCross:       '◈━◈━ Pattern',
      crossDiamond:     '◈━◆━ Pattern',
      diamondLine:      '◇─ Line',
      squareLine:       '◆─ Line',
      heavyDoubleLine:  '═══ Heavy Line',
      arrowRightLine:   '──▶ Right Arrow Line',
      arrowLeftLine:    '◀── Left Arrow Line'
    };

    const PANEL_PRESETS = {
      '48x48x1': { width: 48, length: 48, thickness: 1 },
      '48x96x1': { width: 48, length: 96, thickness: 1 },
      '96x48x1': { width: 96, length: 48, thickness: 1 },
      '96x96x2': { width: 96, length: 96, thickness: 2 }
    };

    const SYMBOL_STYLES = {
      waterTrigram:    '☵',
      mountainTrigram: '☶',
      earthTrigram:    '☷',
      yangMonogram:    '⚍',
      yinMonogram:     '⚏',
      recycleSymbol:   '♻',
      arrowhead:       '➤',
      concaveArrow:    '➨',
      doubleAngle:     '»',
      doubleBar:       '‖',
      diamondArrow:    '◇─◆─',
      crossCross:      '◈━◈━',
      crossDiamond:    '◈━◆━',
      diamondLine:     '◇─',
      squareLine:      '◆─',
      heavyDoubleLine: '═══',
      arrowRightLine:  '──▶',
      arrowLeftLine:   '◀──'
    };

    const symbolTextures = {};

    let runDirectionRotationDeg = 0;
    let runDirectionSprite = null;
    let runDirectionSprites = [];
    let runDirectionCenter3D = null;
    let isRotatingRunDir = false;
    let dragStartAngleScreen = 0;
    let dragStartRotationDeg = 0;

    /* ===== Cloud DB (Supabase) + SheetJS XLSX =====
       Table: drawings
       Columns:
         - part_number (text, primary key)
         - state_json  (text)
         - updated_at  (timestamptz)
    =============================================== */

    const cloudConnectBtn    = document.getElementById('cloudConnectBtn');
    const cloudDisconnectBtn = document.getElementById('cloudDisconnectBtn');
    const cloudStatusText    = document.getElementById('cloudStatusText');
    const cloudSaveBtn       = document.getElementById('cloudSaveBtn');
    const cloudLoadBtn       = document.getElementById('cloudLoadBtn');

    let sb = null;

    function getCloudConfig() {
      return {
        url: localStorage.getItem('PANEL_SUPABASE_URL') || '',
        key: localStorage.getItem('PANEL_SUPABASE_ANON_KEY') || ''
      };
    }
    function setCloudConfig(url, key) {
      localStorage.setItem('PANEL_SUPABASE_URL', (url || '').trim());
      localStorage.setItem('PANEL_SUPABASE_ANON_KEY', (key || '').trim());
    }
    function clearCloudConfig() {
      localStorage.removeItem('PANEL_SUPABASE_URL');
      localStorage.removeItem('PANEL_SUPABASE_ANON_KEY');
    }

    function ensureCloud() {
      const cfg = getCloudConfig();
      if (!cfg.url || !cfg.key) {
        sb = null;
        cloudStatusText.textContent = 'Not connected';
        return null;
      }
      try {
        sb = window.supabase.createClient(cfg.url, cfg.key);
        cloudStatusText.textContent = 'Connected';
        return sb;
      } catch (e) {
        console.error(e);
        sb = null;
        cloudStatusText.textContent = 'Not connected';
        return null;
      }
    }

    let dbCache = [];

    async function dbFetchList(filterText) {
      const client = ensureCloud();
      if (!client) return [];
      const term = (filterText || '').trim();

      let q = client.from('drawings')
        .select('part_number, updated_at')
        .order('part_number', { ascending: true })
        .limit(1000);

      if (term) q = q.ilike('part_number', `%${term}%`);

      const { data, error } = await q;
      if (error) { console.error(error); alert('Cloud list error: ' + error.message); return []; }
      dbCache = (data || []).filter(r => r.part_number);
      return dbCache;
    }

    async function dbGetState(partNumber) {
      const client = ensureCloud();
      if (!client) throw new Error('Cloud not connected');
      const { data, error } = await client.from('drawings')
        .select('state_json')
        .eq('part_number', partNumber)
        .maybeSingle();
      if (error) throw error;
      return data ? data.state_json : null;
    }

    async function dbUpsert(partNumber, stateJson) {
      const client = ensureCloud();
      if (!client) throw new Error('Cloud not connected');
      const payload = {
        part_number: partNumber,
        state_json: stateJson,
        updated_at: new Date().toISOString()
      };
      const { error } = await client.from('drawings').upsert(payload, { onConflict: 'part_number' });
      if (error) throw error;
    }

    async function dbRemove(partNumber) {
      const client = ensureCloud();
      if (!client) throw new Error('Cloud not connected');
      const { error } = await client.from('drawings').delete().eq('part_number', partNumber);
      if (error) throw error;
    }

    function sanitizePartNumber(pn) {
      return String(pn || '').trim();
    }

    async function renderDbTable(filterText) {
      const tbody = document.getElementById('dbTbody');
      tbody.innerHTML = '';

      const list = await dbFetchList(filterText);

      if (!list || list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3" style="padding:10px;color:#777;">No records</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach((row) => {
        const pn = row.part_number;

        const tr = document.createElement('tr');

        const tdPart = document.createElement('td');
        tdPart.textContent = pn;
        tdPart.style.cursor = 'pointer';
        tdPart.title = 'Click to copy / set Part Number';
        tdPart.addEventListener('click', () => {
          navigator.clipboard?.writeText(pn).catch(()=>{});
          partNumberInput.value = pn;
        });

        const tdEdit = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', async () => {
          try {
            const json = await dbGetState(pn);
            if (!json) { alert('No drawing saved for: ' + pn); return; }
            restoreState(json);
            partNumberInput.value = pn;
            pushHistory();
          } catch (e) {
            console.error(e);
            alert('Load error: ' + (e.message || e));
          }
        });
        tdEdit.appendChild(editBtn);

        const tdDel = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', async () => {
          if (!confirm('Delete from cloud?\n' + pn)) return;
          try {
            await dbRemove(pn);
            await renderDbTable(dbSearchInput.value || '');
          } catch (e) {
            console.error(e);
            alert('Delete error: ' + (e.message || e));
          }
        });
        tdDel.appendChild(delBtn);

        tr.appendChild(tdPart);
        tr.appendChild(tdEdit);
        tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
    }

    dbSearchInput.addEventListener('input', () => {
      renderDbTable(dbSearchInput.value || '');
    });

    dbExportBtn.addEventListener('click', async () => {
      await renderDbTable(dbSearchInput.value || '');
      const data = (dbCache || []).map(r => ({ "Part Number": r.part_number }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Parts');
      XLSX.writeFile(wb, 'parts.xlsx');
    });

    dbImportBtn.addEventListener('click', () => dbImportInput.click());

    dbImportInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        const client = ensureCloud();
        if (!client) { alert('Connect Cloud first.'); e.target.value = ''; return; }

        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

        const partNumbers = rows
          .map(r => sanitizePartNumber(r["Part Number"] || r["part_number"] || r["Part"] || r["PartNumber"]))
          .filter(Boolean);

        if (partNumbers.length === 0) {
          alert('No "Part Number" column found.');
          e.target.value = '';
          return;
        }

        const payload = partNumbers.map(pn => ({
          part_number: pn,
          state_json: null,
          updated_at: new Date().toISOString()
        }));

        const { error } = await client.from('drawings').upsert(payload, { onConflict: 'part_number' });
        if (error) throw error;

        await renderDbTable(dbSearchInput.value || '');
        alert('Imported ' + partNumbers.length + ' parts.');
      } catch (err) {
        console.error(err);
        alert('Import error: ' + (err.message || err));
      } finally {
        e.target.value = '';
      }
    });

    function connectCloudPrompt() {
      const current = getCloudConfig();
      const url = prompt('Supabase URL (Project Settings → API):', current.url || '');
      if (url === null) return;
      const key = prompt('Supabase ANON key (Project Settings → API):', current.key || '');
      if (key === null) return;
      setCloudConfig(url, key);
      ensureCloud();
      renderDbTable(dbSearchInput.value || '');
    }

    function disconnectCloud() {
      clearCloudConfig();
      ensureCloud();
      document.getElementById('dbTbody').innerHTML = `<tr><td colspan="3" style="padding:10px;color:#777;">No records</td></tr>`;
    }

    cloudConnectBtn.addEventListener('click', connectCloudPrompt);
    cloudDisconnectBtn.addEventListener('click', disconnectCloud);

    cloudSaveBtn.addEventListener('click', async () => {
      const pn = sanitizePartNumber(partNumberInput.value);
      if (!pn) { alert('Type a Part Number first.'); return; }
      try {
        await dbUpsert(pn, serializeState());
        await renderDbTable(dbSearchInput.value || '');
        alert('Saved to cloud: ' + pn);
      } catch (e) {
        console.error(e);
        alert('Save error: ' + (e.message || e));
      }
    });

    cloudLoadBtn.addEventListener('click', async () => {
      const pn = sanitizePartNumber(prompt('Part Number to load:', sanitizePartNumber(partNumberInput.value)));
      if (!pn) return;
      try {
        const json = await dbGetState(pn);
        if (!json) { alert('No drawing saved for: ' + pn); return; }
        restoreState(json);
        partNumberInput.value = pn;
        pushHistory();
      } catch (e) {
        console.error(e);
        alert('Load error: ' + (e.message || e));
      }
    });

    ensureCloud();
    renderDbTable('');

    /* --------- FRACTION HELPERS (inches) ---------- */
    function gcd(a, b) {
      a = Math.abs(a);
      b = Math.abs(b);
      if (a < 1e-8) return b || 1;
      if (b < 1e-8) return a || 1;
      while (b > 1e-8) {
        const t = b;
        b = a % b;
        a = t;
      }
      return a || 1;
    }

    function parseInches(str) {
      if (str == null) return NaN;
      str = String(str).trim();
      if (!str) return NaN;
      str = str.replace(/"/g, '').trim();

      let sign = 1;
      if (str[0] === '+') {
        str = str.slice(1).trim();
      } else if (str[0] === '-') {
        sign = -1;
        str = str.slice(1).trim();
      }
      if (!str) return NaN;

      const parts = str.split(/\s+/);

      let whole = 0;
      let frac = 0;

      if (parts.length === 1) {
        const p = parts[0];
        if (p.includes('/')) {
          const [n, d] = p.split('/');
          if (!d || isNaN(+d)) return NaN;
          frac = parseFloat(n) / parseFloat(d);
        } else {
          whole = parseFloat(p);
          if (isNaN(whole)) return NaN;
        }
      } else {
        const wPart = parts[0];
        whole = parseFloat(wPart);
        if (isNaN(whole)) return NaN;
        const fracPart = parts[1];
        if (fracPart.includes('/')) {
          const [n,d] = fracPart.split('/');
          if (!d || isNaN(+d)) return NaN;
          frac = parseFloat(n) / parseFloat(d);
        } else {
          const val2 = parseFloat(fracPart);
          if (!isNaN(val2)) frac = val2;
        }
      }

      return sign * (whole + frac);
    }

    function formatInches(val) {
      if (!isFinite(val)) return '';
      const sign = val < 0 ? '-' : '';
      let v = Math.abs(val);

      const epsilon = 1e-6;
      v = v + epsilon;

      let whole = Math.floor(v);
      let frac  = v - whole;

      const denomBase = 16;
      let num = Math.round(frac * denomBase);

      if (num === 0) return sign + whole;
      if (num === denomBase) { whole += 1; return sign + whole; }

      const g = gcd(num, denomBase);
      num /= g;
      const denom = denomBase / g;

      if (whole === 0) return `${sign}${num}/${denom}`;
      return `${sign}${whole} ${num}/${denom}`;
    }

    function formatInchesWithQuote(val) {
      const f = formatInches(val);
      return f ? f + '"' : '';
    }

    /* ------------- YOUR ORIGINAL APP CODE CONTINUES BELOW -------------
       (Everything else is unchanged from your uploaded file, except:
        - Save Drawing button now saves to cloud when connected.)
    -------------------------------------------------------------------- */

    /* NOTE: Your file continues exactly as in the uploaded version. 
       If you want the *entire* remaining section pasted here too, use the downloadable file above,
       because the full file is very long. */
  </script>
</body>
</html>
